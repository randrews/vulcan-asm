<!DOCTYPE html>

<html>
<head>
  <title>../vasm_test.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="locco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    <div id="jump_to">
  Jump To &hellip;
  <div id="jump_wrapper">
  <div id="jump_page">
  <a class="source" href="cpu.html">../cpu.lua</a>
  <a class="source" href="display.html">../display.lua</a>
  <a class="source" href="vasm.html">../vasm.lua</a>
  <a class="source" href="vasm_test.html">../vasm_test.lua</a>
  <a class="source" href="vemu.html">../vemu.lua</a>
  <a class="source" href="vemu_test.html">../vemu_test.lua</a>
    </div>
  </div>
</div>

    <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
              ../vasm_test.lua
            </h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
<tr id="section-1">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-1">&#182;</a>
  </div>
  


</td>
<td class="code">
  <div class="highlight"><pre>vulcan = <span class="nt">require</span>(<span class="s">'vasm'</span>)

statement = vulcan.statement
</pre></div>
</td>
</tr><tr id="section-2">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-2">&#182;</a>
  </div>
  
<h1>Assembly parsing tests</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-3">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-3">&#182;</a>
  </div>
  
<h2>Utility functions</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-4">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-4">&#182;</a>
  </div>
  
<p>Pretty-print an array</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">prettify</span>(t)
</pre></div>
</td>
</tr><tr id="section-5">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-5">&#182;</a>
  </div>
  
<p>It's an empty object or an array</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">if</span> t[1] <span class="o">or</span> <span class="o">not</span> <span class="nt">next</span>(t) <span class="k">then</span>
        <span class="k">local</span> elements = table.map(t, <span class="k">function</span>(el)
                                       <span class="k">if</span> <span class="nt">type</span>(el) == <span class="s">'table'</span> <span class="k">then</span>
                                           <span class="k">return</span> prettify(el)
                                       <span class="k">else</span>
                                           <span class="k">return</span> string.format(<span class="s">'&#37;q'</span>, el)
                                       <span class="k">end</span>
        <span class="k">end</span>)

        <span class="k">return</span> <span class="s">'('</span> .. table.concat(elements, <span class="s">' '</span>) .. <span class="s">')'</span>
    <span class="k">else</span>
</pre></div>
</td>
</tr><tr id="section-6">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-6">&#182;</a>
  </div>
  
<p>It has a key but that key isn't 1, so it's a hash / object:</p>


</td>
<td class="code">
  <div class="highlight"><pre>        <span class="k">local</span> elements = {}
        <span class="k">local</span> keys = {}

        <span class="k">for</span> k, _ <span class="k">in</span> <span class="nt">pairs</span>(t) <span class="k">do</span>
            table.insert(keys, k)
        <span class="k">end</span>

        table.sort(keys)

        <span class="k">for</span> _, k <span class="k">in</span> <span class="nt">ipairs</span>(keys) <span class="k">do</span>
            <span class="k">local</span> v = t[k]
            <span class="k">if</span> <span class="nt">type</span>(v) == <span class="s">'table'</span> <span class="k">then</span>
                table.insert(elements, k .. <span class="s">'='</span> .. prettify(v))
            <span class="k">else</span>
                table.insert(elements, k .. <span class="s">'='</span> .. string.format(<span class="s">'&#37;q'</span>, v))
            <span class="k">end</span>
        <span class="k">end</span>
        <span class="k">return</span> <span class="s">'{'</span> .. table.concat(elements, <span class="s">' '</span>) .. <span class="s">'}'</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-7">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-7">&#182;</a>
  </div>
  
<p>A debugging aid to pretty-print our internal representation of an instruction</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">print_line</span>(line, recur)
    <span class="k">local</span> elements = {}
    <span class="k">local</span> keys = {}

    <span class="k">for</span> k, _ <span class="k">in</span> <span class="nt">pairs</span>(line) <span class="k">do</span>
        table.insert(keys, k)
    <span class="k">end</span>

    table.sort(keys)

    <span class="k">for</span> _, k <span class="k">in</span> <span class="nt">ipairs</span>(keys) <span class="k">do</span>
        <span class="k">local</span> v = line[k]
        <span class="k">if</span> <span class="nt">type</span>(v) == <span class="s">'table'</span> <span class="k">then</span>
            table.insert(elements, k .. <span class="s">'='</span> .. print_line(v, <span class="k">true</span>))
        <span class="k">else</span>
            table.insert(elements, k .. <span class="s">'='</span> .. string.format(<span class="s">'&#37;q'</span>, v))
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">local</span> str = <span class="s">'{'</span> .. table.concat(elements, <span class="s">' '</span>) .. <span class="s">'}'</span>
    <span class="k">if</span> recur <span class="k">then</span>
        <span class="k">return</span> str
    <span class="k">else</span>
        <span class="nt">print</span>(str)
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-8">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-8">&#182;</a>
  </div>
  
<p>A wrapper for testing that ASTs are equal:</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">test</span>(line, ast)
    <span class="k">local</span> actual_ast = prettify(statement:match(line))
    <span class="k">if</span> actual_ast == ast <span class="k">then</span> <span class="k">return</span> <span class="k">true</span>
    <span class="k">else</span>
        <span class="nt">print</span>(<span class="s">'FAIL: [['</span> .. line .. <span class="s">']]\nExpected: '</span> .. ast .. <span class="s">'\n  Actual: '</span> .. actual_ast)
        <span class="k">return</span> <span class="k">false</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-9">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-9">&#182;</a>
  </div>
  
<h2>Test cases</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-10">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-10">&#182;</a>
  </div>
  
<p>Just an opcode</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[add]]</span>, <span class="s">[[("opcode" "add")]]</span>)
</pre></div>
</td>
</tr><tr id="section-11">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-11">&#182;</a>
  </div>
  
<p>Leading spaces</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[   add]]</span>, <span class="s">[[("opcode" "add")]]</span>)
</pre></div>
</td>
</tr><tr id="section-12">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-12">&#182;</a>
  </div>
  
<p>Opcode with an argument</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[add 43]]</span>, <span class="s">[[("opcode" "add" "argument" ("expr" ("term" 43)))]]</span>)
</pre></div>
</td>
</tr><tr id="section-13">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-13">&#182;</a>
  </div>
  
<p>Another with an argument</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[load24 43]]</span>, <span class="s">[[("opcode" "load24" "argument" ("expr" ("term" 43)))]]</span>)
</pre></div>
</td>
</tr><tr id="section-14">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-14">&#182;</a>
  </div>
  
<p>Label, opcode, argument</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[foo: add 43]]</span>, <span class="s">[[("label" "foo" "opcode" "add" "argument" ("expr" ("term" 43)))]]</span>)
</pre></div>
</td>
</tr><tr id="section-15">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-15">&#182;</a>
  </div>
  
<p>Label, opcode</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[foo: add]]</span>, <span class="s">[[("label" "foo" "opcode" "add")]]</span>)
</pre></div>
</td>
</tr><tr id="section-16">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-16">&#182;</a>
  </div>
  
<p>Hex argument</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[add 0x10]]</span>, <span class="s">[[("opcode" "add" "argument" ("expr" ("term" 16)))]]</span>)
</pre></div>
</td>
</tr><tr id="section-17">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-17">&#182;</a>
  </div>
  
<p>Binary argument</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[add 0b1010]]</span>, <span class="s">[[("opcode" "add" "argument" ("expr" ("term" 10)))]]</span>)
</pre></div>
</td>
</tr><tr id="section-18">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-18">&#182;</a>
  </div>
  
<p>Decimal argument</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[add 23]]</span>, <span class="s">[[("opcode" "add" "argument" ("expr" ("term" 23)))]]</span>)
</pre></div>
</td>
</tr><tr id="section-19">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-19">&#182;</a>
  </div>
  
<p>Decimal zero argument</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[add 0]]</span>, <span class="s">[[("opcode" "add" "argument" ("expr" ("term" 0)))]]</span>)
</pre></div>
</td>
</tr><tr id="section-20">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-20">&#182;</a>
  </div>
  
<p>Strings</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[  .db "hello"]]</span>, <span class="s">[[("directive" ".db" "argument" ("string" ("h" "e" "l" "l" "o")))]]</span>)
</pre></div>
</td>
</tr><tr id="section-21">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-21">&#182;</a>
  </div>
  
<p>Strings with escapes</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[  .db "hello\""]]</span>, <span class="s">[[("directive" ".db" "argument" ("string" ("h" "e" "l" "l" "o" "\\\"")))]]</span>)
</pre></div>
</td>
</tr><tr id="section-22">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-22">&#182;</a>
  </div>
  
<p>Expressions</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[add 43+17]]</span>, <span class="s">[[("opcode" "add" "argument" ("expr" ("term" 43) "+" ("term" 17)))]]</span>)
</pre></div>
</td>
</tr><tr id="section-23">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-23">&#182;</a>
  </div>
  
<p>Multiple terms</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[add 43+17 - 3]]</span>, <span class="s">[[("opcode" "add" "argument" ("expr" ("term" 43) "+" ("term" 17) "-" ("term" 3)))]]</span>)
</pre></div>
</td>
</tr><tr id="section-24">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-24">&#182;</a>
  </div>
  
<p>Multiplication</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[add 2*14-3]]</span>, <span class="s">[[("opcode" "add" "argument" ("expr" ("term" 2 "*" 14) "-" ("term" 3)))]]</span>)
</pre></div>
</td>
</tr><tr id="section-25">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-25">&#182;</a>
  </div>
  
<p>Sub-expressions</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[add 2*(14-3)]]</span>, <span class="s">[[("opcode" "add" "argument" ("expr" ("term" 2 "*" ("expr" ("term" 14) "-" ("term" 3)))))]]</span>)
</pre></div>
</td>
</tr><tr id="section-26">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-26">&#182;</a>
  </div>
  
<p>Labels in expressions</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[jmp start + 2]]</span>, <span class="s">[[("opcode" "jmp" "argument" ("expr" ("term" "start") "+" ("term" 2)))]]</span>)
</pre></div>
</td>
</tr><tr id="section-27">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-27">&#182;</a>
  </div>
  
<p>Relative labels in expressions</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[brnz @loop]]</span>, <span class="s">[[("opcode" "brnz" "argument" ("expr" ("term" "@loop")))]]</span>)
</pre></div>
</td>
</tr><tr id="section-28">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-28">&#182;</a>
  </div>
  
<p>Comments</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[hlt ; whatever]]</span>, <span class="s">[[("opcode" "hlt")]]</span>)
</pre></div>
</td>
</tr><tr id="section-29">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-29">&#182;</a>
  </div>
  
<p>Just a comment</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[; whatever]]</span>, <span class="s">[[()]]</span>)
</pre></div>
</td>
</tr><tr id="section-30">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-30">&#182;</a>
  </div>
  
<p>Just whitespace</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[     ]]</span>, <span class="s">[[()]]</span>)
</pre></div>
</td>
</tr><tr id="section-31">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-31">&#182;</a>
  </div>
  
<p>Blank line</p>


</td>
<td class="code">
  <div class="highlight"><pre>test(<span class="s">[[]]</span>, <span class="s">[[()]]</span>)
</pre></div>
</td>
</tr><tr id="section-32">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-32">&#182;</a>
  </div>
  
<h1>Assembler first-pass tests</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
parse_assembly = vulcan.parse_assembly
</pre></div>
</td>
</tr><tr id="section-33">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-33">&#182;</a>
  </div>
  
<h2>Utility functions</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-34">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-34">&#182;</a>
  </div>
  
<p>Fake an iterator from a string</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">iterator</span>(str)
    <span class="k">return</span> <span class="k">function</span>()
        <span class="k">if</span> str == <span class="s">''</span> <span class="k">then</span> <span class="k">return</span> <span class="k">nil</span> <span class="k">end</span>
        <span class="k">local</span> endl = str:find(<span class="s">'\n'</span>)
        <span class="k">if</span> <span class="o">not</span> endl <span class="k">then</span> endl = #str+1 <span class="k">end</span>
        <span class="k">local</span> current_line = str:sub(1, endl-1)
        str = str:sub(endl + 1)
        <span class="k">return</span> current_line
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-35">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-35">&#182;</a>
  </div>
  
<p>Wrapper for testing with an iterator</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">test_parse</span>(asm, lines)
    <span class="k">local</span> actual_lines = prettify(parse_assembly(iterator(asm)))

    <span class="k">if</span> actual_lines == lines <span class="k">then</span> <span class="k">return</span> <span class="k">true</span>
    <span class="k">else</span>
        <span class="nt">print</span>(<span class="s">'FAIL:\nExpected: '</span> .. lines .. <span class="s">'\n  Actual: '</span> .. actual_lines)
        <span class="k">return</span> <span class="k">false</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-36">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-36">&#182;</a>
  </div>
  
<p>Test that an error actually occurs</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">test_parse_error</span>(asm, message)
    <span class="k">local</span> status, actual_err = <span class="nt">pcall</span>(<span class="k">function</span>()
            <span class="k">return</span> prettify(parse_assembly(iterator(asm)))
    <span class="k">end</span>)

    <span class="k">if</span> status <span class="k">then</span>
        <span class="nt">print</span>(<span class="s">'FAIL:\nExpected error \"'</span> .. err .. <span class="s">'\" but nothing was thrown'</span>)
        <span class="nt">print</span>(<span class="s">'Return value: '</span> .. actual_err)
    <span class="k">else</span>
        <span class="k">local</span> index = actual_err:find(message)
        <span class="k">if</span> <span class="o">not</span> index <span class="k">then</span>
            <span class="nt">print</span>(<span class="s">'FAIL:\nExpected error to contain: '</span> .. message .. <span class="s">'\n             Actual error: '</span> .. actual_err)
            <span class="k">return</span> <span class="k">false</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-37">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-37">&#182;</a>
  </div>
  
<h2>Test cases</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-38">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-38">&#182;</a>
  </div>
  
<p>It should parse simple files</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_parse(<span class="s">[[
    ;; With n at top of stack, replaces it with the
    ;; nth triangular series number

triangular:
    dup
    sub 1
    mul
]]</span>, <span class="s">[[({label="triangular" line=4} {line=5 opcode="dup"} {argument=("expr" ("term" 1)) line=6 opcode="sub"} {line=7 opcode="mul"})]]</span>)
</pre></div>
</td>
</tr><tr id="section-39">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-39">&#182;</a>
  </div>
  
<p>It should disallow string arguments except in .db</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_parse_error(<span class="s">[[add "hello"]]</span>, <span class="s">[[String argument outside .db directive]]</span>)
</pre></div>
</td>
</tr><tr id="section-40">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-40">&#182;</a>
  </div>
  
<p>It should allow string arguments in .db</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_parse(<span class="s">[[.db "hello"]]</span>, <span class="s">[[({argument=("string" ("h" "e" "l" "l" "o")) directive=".db" line=1})]]</span>)
</pre></div>
</td>
</tr><tr id="section-41">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-41">&#182;</a>
  </div>
  
<h1>Expression evaluator tests</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
evaluate = vulcan.evaluate
</pre></div>
</td>
</tr><tr id="section-42">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-42">&#182;</a>
  </div>
  
<h2>Utility functions</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
<span class="k">function</span> <span class="nf">test_eval</span>(ast, val, symbols, start_address)
    <span class="k">local</span> actual_val = evaluate(ast, symbols <span class="o">or</span> {}, start_address)
    <span class="k">if</span> <span class="nt">type</span>(actual_val) == <span class="s">'table'</span> <span class="k">then</span>
        actual_val = prettify(actual_val)
        val = prettify({ val:byte(1, #val) })
    <span class="k">end</span>

    <span class="k">if</span> actual_val == val <span class="k">then</span> <span class="k">return</span> <span class="k">true</span>
    <span class="k">else</span>
        <span class="nt">print</span>(<span class="s">'FAIL:\nExpected: '</span> .. val .. <span class="s">'\n  Actual: '</span> .. actual_val)
        <span class="k">return</span> <span class="k">false</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-43">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-43">&#182;</a>
  </div>
  
<h2>Test cases</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-44">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-44">&#182;</a>
  </div>
  
<p>Most basic and common case, a number:</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_eval({<span class="s">'expr'</span>, {<span class="s">'term'</span>, 43}}, 43)
</pre></div>
</td>
</tr><tr id="section-45">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-45">&#182;</a>
  </div>
  
<p>Some addition and subtraction</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_eval({<span class="s">'expr'</span>, {<span class="s">'term'</span>, 10}, <span class="s">'+'</span>, {<span class="s">'term'</span>, 5}, <span class="s">'-'</span>, {<span class="s">'term'</span>, 2}}, 13)
</pre></div>
</td>
</tr><tr id="section-46">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-46">&#182;</a>
  </div>
  
<p>Multiplication and order of operations</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_eval({<span class="s">'expr'</span>, {<span class="s">'term'</span>, 2, <span class="s">'*'</span>, 14}, <span class="s">'-'</span>, {<span class="s">'term'</span>, 3}}, 25)
</pre></div>
</td>
</tr><tr id="section-47">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-47">&#182;</a>
  </div>
  
<p>Symbol table lookups</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_eval({<span class="s">'expr'</span>, {<span class="s">'term'</span>, <span class="s">'start'</span>}, <span class="s">'+'</span>, {<span class="s">'term'</span>, 2}}, 12, {start=10})
</pre></div>
</td>
</tr><tr id="section-48">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-48">&#182;</a>
  </div>
  
<p>Failing symbol table lookup</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">local</span> success, err = <span class="nt">pcall</span>(<span class="k">function</span>()
        evaluate({<span class="s">'expr'</span>, {<span class="s">'term'</span>, <span class="s">'start'</span>}, <span class="s">'+'</span>, {<span class="s">'term'</span>, 2}}, {})
<span class="k">end</span>)
<span class="nt">assert</span>(success == <span class="k">false</span> <span class="o">and</span> err:match(<span class="s">'Symbol not defined: start'</span>))
</pre></div>
</td>
</tr><tr id="section-49">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-49">&#182;</a>
  </div>
  
<p>Relative label lookups</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_eval({<span class="s">'expr'</span>, {<span class="s">'term'</span>, <span class="s">'@loop'</span>}}, 5, {loop=15}, 10)
</pre></div>
</td>
</tr><tr id="section-50">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-50">&#182;</a>
  </div>
  
<p>Failing relative label lookup</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">local</span> success, err = <span class="nt">pcall</span>(<span class="k">function</span>()
        evaluate({<span class="s">'expr'</span>, {<span class="s">'term'</span>, <span class="s">'@loop'</span>}}, {}, 5, 10)
<span class="k">end</span>)
<span class="nt">assert</span>(success == <span class="k">false</span> <span class="o">and</span> err:match(<span class="s">'Symbol not defined: loop'</span>))
</pre></div>
</td>
</tr><tr id="section-51">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-51">&#182;</a>
  </div>
  
<p>A parsed string</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_eval({<span class="s">'string'</span>, {<span class="s">'H'</span>, <span class="s">'e'</span>, <span class="s">'l'</span>, <span class="s">'l'</span>, <span class="s">'o'</span>}}, <span class="s">'Hello'</span>)
</pre></div>
</td>
</tr><tr id="section-52">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-52">&#182;</a>
  </div>
  
<p>A parsed string with escapes</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_eval({<span class="s">'string'</span>, {<span class="s">'H'</span>, <span class="s">'e'</span>, <span class="s">'l'</span>, <span class="s">'l'</span>, <span class="s">'o'</span>, <span class="s">'\\"'</span>}}, <span class="s">'Hello"'</span>)
</pre></div>
</td>
</tr><tr id="section-53">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-53">&#182;</a>
  </div>
  
<h1>Second pass tests</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
solve_equs = vulcan.solve_equs
</pre></div>
</td>
</tr><tr id="section-54">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-54">&#182;</a>
  </div>
  
<h2>Utility functions</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
<span class="k">function</span> <span class="nf">test_equs</span>(asm, symbols)
    <span class="k">local</span> actual_symbols = prettify(solve_equs(parse_assembly(iterator(asm))))

    <span class="k">if</span> actual_symbols == symbols <span class="k">then</span> <span class="k">return</span> <span class="k">true</span>
    <span class="k">else</span>
        <span class="nt">print</span>(<span class="s">'FAIL:\nExpected: '</span> .. symbols .. <span class="s">'\n  Actual: '</span> .. actual_symbols)
        <span class="k">return</span> <span class="k">false</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-55">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-55">&#182;</a>
  </div>
  
<h2>Test cases</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-56">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-56">&#182;</a>
  </div>
  
<p>Simple case</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_equs(<span class="s">[[foo: .equ 5]]</span>, <span class="s">[[{foo=5}]]</span>)
</pre></div>
</td>
</tr><tr id="section-57">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-57">&#182;</a>
  </div>
  
<p>One refers to another</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_equs(<span class="s">[[
foo: .equ 5
bar: .equ foo+6
]]</span>, <span class="s">[[{bar=11 foo=5}]]</span>)
</pre></div>
</td>
</tr><tr id="section-58">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-58">&#182;</a>
  </div>
  
<p>Fails to resolve symbol:</p>


</td>
<td class="code">
  <div class="highlight"><pre>success, err = <span class="nt">pcall</span>(test_equs, <span class="s">[[foo: .equ bar]]</span>, <span class="s">''</span>)
<span class="nt">assert</span>(success == <span class="k">false</span> <span class="o">and</span>
           err:match(<span class="s">'Cannot resolve .equ on line 1:'</span>) <span class="o">and</span>
           err:match(<span class="s">'Symbol not defined: bar'</span>))
</pre></div>
</td>
</tr><tr id="section-59">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-59">&#182;</a>
  </div>
  
<p>Contains a relative address:</p>


</td>
<td class="code">
  <div class="highlight"><pre>success, err = <span class="nt">pcall</span>(test_equs, <span class="s">[[foo: .equ @bar]]</span>, <span class="s">''</span>)
<span class="nt">assert</span>(success == <span class="k">false</span> <span class="o">and</span>
           err:match(<span class="s">'Cannot resolve .equ on line 1:'</span>) <span class="o">and</span>
           err:match(<span class="s">'Cannot resolve relative label'</span>))
</pre></div>
</td>
</tr><tr id="section-60">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-60">&#182;</a>
  </div>
  
<h1>Third pass tests</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
measure_instructions = vulcan.measure_instructions
</pre></div>
</td>
</tr><tr id="section-61">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-61">&#182;</a>
  </div>
  
<h2>Utility functions</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
<span class="k">function</span> <span class="nf">test_measure</span>(asm, lengths)
    <span class="k">local</span> lines = parse_assembly(iterator(asm))
    <span class="k">local</span> symbols = solve_equs(lines)
    measure_instructions(lines, symbols)
    <span class="k">local</span> actual_lengths = prettify(table.map(lines, <span class="k">function</span>(l) <span class="k">return</span> l.length <span class="k">end</span>))

    <span class="k">if</span> actual_lengths == lengths <span class="k">then</span> <span class="k">return</span> <span class="k">true</span>
    <span class="k">else</span>
        <span class="nt">print</span>(<span class="s">'FAIL:\nExpected: '</span> .. lengths .. <span class="s">'\n  Actual: '</span> .. actual_lengths)
        <span class="k">return</span> <span class="k">false</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-62">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-62">&#182;</a>
  </div>
  
<h2>Test cases</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-63">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-63">&#182;</a>
  </div>
  
<p>Some single-byte stuff</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_measure(<span class="s">[[
add
jmp
nop
]]</span>, <span class="s">[[(1 1 1)]]</span>)
</pre></div>
</td>
</tr><tr id="section-64">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-64">&#182;</a>
  </div>
  
<p>.db with a number</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_measure(<span class="s">[[.db 123]]</span>, <span class="s">[[(3)]]</span>)
</pre></div>
</td>
</tr><tr id="section-65">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-65">&#182;</a>
  </div>
  
<p>.db with a string</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_measure(<span class="s">[[.db "potato!"]]</span>, <span class="s">[[(7)]]</span>)
</pre></div>
</td>
</tr><tr id="section-66">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-66">&#182;</a>
  </div>
  
<p>Things that don't output</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_measure(<span class="s">[[
.org 123
foo: .equ 234
]]</span>, <span class="s">[[(0 0)]]</span>)
</pre></div>
</td>
</tr><tr id="section-67">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-67">&#182;</a>
  </div>
  
<p>Single-byte args</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_measure(<span class="s">[[push 0x23]]</span>, <span class="s">[[(2)]]</span>)
</pre></div>
</td>
</tr><tr id="section-68">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-68">&#182;</a>
  </div>
  
<p>Two-byte args</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_measure(<span class="s">[[push 0x1023]]</span>, <span class="s">[[(3)]]</span>)
</pre></div>
</td>
</tr><tr id="section-69">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-69">&#182;</a>
  </div>
  
<p>Three-byte args</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_measure(<span class="s">[[push 0xaa1023]]</span>, <span class="s">[[(4)]]</span>)
</pre></div>
</td>
</tr><tr id="section-70">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-70">&#182;</a>
  </div>
  
<p>Args with unknown length</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_measure(<span class="s">[[push banana+12]]</span>, <span class="s">[[(4)]]</span>)
</pre></div>
</td>
</tr><tr id="section-71">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-71">&#182;</a>
  </div>
  
<p>Relative label args</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_measure(<span class="s">[[brnz @loop]]</span>, <span class="s">[[(4)]]</span>)
</pre></div>
</td>
</tr><tr id="section-72">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-72">&#182;</a>
  </div>
  
<h1>Fourth pass tests</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
place_labels = vulcan.place_labels
</pre></div>
</td>
</tr><tr id="section-73">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-73">&#182;</a>
  </div>
  
<h2>Utility functions</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
<span class="k">function</span> <span class="nf">test_place</span>(asm, addresses, symbols)
    <span class="k">local</span> lines = parse_assembly(iterator(asm))
    <span class="k">local</span> actual_symbols = solve_equs(lines)
    measure_instructions(lines, actual_symbols)
    place_labels(lines, actual_symbols)
    <span class="k">local</span> actual_addresses = prettify(table.map(lines, <span class="k">function</span>(l) <span class="k">return</span> l.address <span class="k">end</span>))

    <span class="k">if</span> addresses <span class="o">and</span> actual_addresses ~= addresses <span class="k">then</span>
        <span class="nt">print</span>(<span class="s">'FAIL:\nExpected: '</span> .. addresses .. <span class="s">'\n  Actual: '</span> .. actual_addresses)
        <span class="k">return</span> <span class="k">false</span>
    <span class="k">end</span>

    <span class="k">if</span> symbols <span class="o">and</span> symbols ~= prettify(actual_symbols) <span class="k">then</span>
        <span class="nt">print</span>(<span class="s">'FAIL:\nExpected: '</span> .. symbols .. <span class="s">'\n  Actual: '</span> .. prettify(actual_symbols))
        <span class="k">return</span> <span class="k">false</span>
    <span class="k">end</span>

    <span class="k">return</span> <span class="k">true</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-74">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-74">&#182;</a>
  </div>
  
<h2>Test cases</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-75">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-75">&#182;</a>
  </div>
  
<p>Simple</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_place(<span class="s">[[
add 12
sub
]]</span>, <span class="s">[[(0 2)]]</span>, <span class="s">[[{$end=2 $start=0}]]</span>)
</pre></div>
</td>
</tr><tr id="section-76">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-76">&#182;</a>
  </div>
  
<p>With a constant .org</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_place(<span class="s">[[
.org 1000
add 12]]</span>, <span class="s">[[(1000 1000)]]</span>)
</pre></div>
</td>
</tr><tr id="section-77">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-77">&#182;</a>
  </div>
  
<p>With a label</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_place(<span class="s">[[
start: add
sub]]</span>, <span class="s">[[(0 1)]]</span>, <span class="s">[[{$end=1 $start=0 start=0}]]</span>)
</pre></div>
</td>
</tr><tr id="section-78">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-78">&#182;</a>
  </div>
  
<p>With a .org referring to a label</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_place(<span class="s">[[
.org 100
jt_start: jmpr
.org jt_start+7
add 7]]</span>, <span class="s">[[(100 100 107 107)]]</span>, <span class="s">[[{$end=108 $start=100 jt_start=100}]]</span>)
</pre></div>
</td>
</tr><tr id="section-79">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-79">&#182;</a>
  </div>
  
<p>A .org we can't calculate</p>


</td>
<td class="code">
  <div class="highlight"><pre>success, err = <span class="nt">pcall</span>(test_place,<span class="s">[[
.org start+10
add
start: sub]]</span>)
<span class="nt">assert</span>(success == <span class="k">false</span> <span class="o">and</span> err:match(<span class="s">'Unable to resolve .org on line 1'</span>))
</pre></div>
</td>
</tr><tr id="section-80">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-80">&#182;</a>
  </div>
  
<p>It shouldn't reassign .equs</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_place(<span class="s">[[
blah: .equ 17
mul blah*2]]</span>, <span class="k">nil</span>, <span class="s">[[{$end=1 $start=0 blah=17}]]</span>)
</pre></div>
</td>
</tr><tr id="section-81">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-81">&#182;</a>
  </div>
  
<p>Calculates a correct start address</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_place(<span class="s">[[
.org 123
nop]]</span>, <span class="k">nil</span>, <span class="s">[[{$end=123 $start=123}]]</span>)
</pre></div>
</td>
</tr><tr id="section-82">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-82">&#182;</a>
  </div>
  
<p>A .org with a relative label:</p>


</td>
<td class="code">
  <div class="highlight"><pre>success, err = <span class="nt">pcall</span>(test_place,<span class="s">[[.org @loop+4]]</span>)
<span class="nt">assert</span>(success == <span class="k">false</span>
           <span class="o">and</span> err:match(<span class="s">'Unable to resolve .org on line 1'</span>)
           <span class="o">and</span> err:match(<span class="s">'Cannot resolve relative label'</span>))
</pre></div>
</td>
</tr><tr id="section-83">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-83">&#182;</a>
  </div>
  
<h1>Fifth pass tests</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
calculate_args = vulcan.calculate_args
</pre></div>
</td>
</tr><tr id="section-84">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-84">&#182;</a>
  </div>
  
<h2>Utility functions</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
<span class="k">function</span> <span class="nf">test_calculate</span>(asm, args)
    <span class="k">local</span> lines = parse_assembly(iterator(asm))
    <span class="k">local</span> symbols = solve_equs(lines)
    measure_instructions(lines, symbols)
    place_labels(lines, symbols)
    calculate_args(lines, symbols)
    <span class="k">local</span> actual_args = prettify(table.map(lines, <span class="k">function</span>(l) <span class="k">return</span> l.argument <span class="o">or</span> 0 <span class="k">end</span>))

    <span class="k">if</span> actual_args ~= args <span class="k">then</span>
        <span class="nt">print</span>(<span class="s">'FAIL:\nExpected: '</span> .. args .. <span class="s">'\n  Actual: '</span> .. actual_args)
        <span class="k">return</span> <span class="k">false</span>
    <span class="k">end</span>

    <span class="k">return</span> <span class="k">true</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-85">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-85">&#182;</a>
  </div>
  
<h2>Test cases</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-86">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-86">&#182;</a>
  </div>
  
<p>Simple</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_calculate(<span class="s">[[add 25]]</span>, <span class="s">[[(25)]]</span>)
</pre></div>
</td>
</tr><tr id="section-87">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-87">&#182;</a>
  </div>
  
<p>Arithmetic</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_calculate(<span class="s">[[add 2+3*6]]</span>, <span class="s">[[(20)]]</span>)
</pre></div>
</td>
</tr><tr id="section-88">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-88">&#182;</a>
  </div>
  
<p>Referring to labels</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_calculate(<span class="s">[[
foo: .org 100
add foo+5
]]</span>, <span class="s">[[(100 105)]]</span>)
</pre></div>
</td>
</tr><tr id="section-89">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-89">&#182;</a>
  </div>
  
<p>Referring to .equs</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_calculate(<span class="s">[[
blah: .equ 17
mul blah*2]]</span>, <span class="s">[[(17 34)]]</span> )
</pre></div>
</td>
</tr><tr id="section-90">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-90">&#182;</a>
  </div>
  
<p>Referring to relative labels</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_calculate(<span class="s">[[
loop: sub 1
brnz @loop
]]</span>, <span class="s">[[(1 -2)]]</span>)
</pre></div>
</td>
</tr><tr id="section-91">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-91">&#182;</a>
  </div>
  
<h1>Full assembler tests</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
assemble = vulcan.assemble
</pre></div>
</td>
</tr><tr id="section-92">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-92">&#182;</a>
  </div>
  
<h2>Utility functions</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
<span class="k">function</span> <span class="nf">test_assemble</span>(asm, bytes)
    <span class="k">local</span> actual_bytes = assemble(iterator(asm))

    <span class="k">if</span> #actual_bytes + 1 ~= #bytes <span class="k">then</span>
        <span class="nt">print</span>(<span class="s">'FAIL:\nExpected: '</span> .. (#bytes) .. <span class="s">' bytes to be generated\n  Actual: '</span> .. (#actual_bytes+1))
        <span class="k">return</span> <span class="k">false</span>
    <span class="k">end</span>

    <span class="k">for</span> idx, byte <span class="k">in</span> <span class="nt">ipairs</span>(bytes) <span class="k">do</span>
        <span class="k">local</span> actual_byte = actual_bytes[idx-1]
        <span class="k">if</span> byte ~= actual_byte <span class="k">then</span>
            <span class="nt">print</span>(<span class="s">'FAIL:\nExpected: '</span> .. byte_tostring(byte) .. <span class="s">' at index '</span> .. idx .. <span class="s">'\n  Actual: '</span> .. byte_tostring(actual_byte))
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="k">true</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">byte_tostring</span>(byte)
    <span class="k">if</span> byte &lt; 16 <span class="k">then</span>
        <span class="k">return</span> string.format(<span class="s">'0x0&#37;x'</span>, byte)
    <span class="k">else</span>
        <span class="k">return</span> string.format(<span class="s">'0x&#37;x'</span>, byte)
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-93">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-93">&#182;</a>
  </div>
  
<h2>Test cases</h2>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-94">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-94">&#182;</a>
  </div>
  
<p>Null program</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[ nop ]]</span>, {0})
</pre></div>
</td>
</tr><tr id="section-95">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-95">&#182;</a>
  </div>
  
<p>Opcodes</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
 add
 sub
 mul ]]</span>, {4, 8, 12})
</pre></div>
</td>
</tr><tr id="section-96">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-96">&#182;</a>
  </div>
  
<p>Instructions with arguments</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
push 0x10
add 0x10 ]]</span>, {0x01, 0x10, 0x05, 0x10})
</pre></div>
</td>
</tr><tr id="section-97">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-97">&#182;</a>
  </div>
  
<p>Instructions with negative arguments</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
loop: sub 1
brnz @loop]]</span>, {0x09, 0x01, 0x67, 0xfe, 0xff, 0xff})
</pre></div>
</td>
</tr><tr id="section-98">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-98">&#182;</a>
  </div>
  
<p>Instructions with arguments and a .org</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
.org 0x0100
push 0x10
add 0x10 ]]</span>, {0x01, 0x10, 0x05, 0x10})
</pre></div>
</td>
</tr><tr id="section-99">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-99">&#182;</a>
  </div>
  
<p>Instructions with long arguments</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
push 0x123456
add 0x1234 ]]</span>, {0x03, 0x56, 0x34, 0x12, 0x06, 0x34, 0x12})
</pre></div>
</td>
</tr><tr id="section-100">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-100">&#182;</a>
  </div>
  
<p>.org directives at the beginning</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
.org 123
nop ]]</span>, {0x00})
</pre></div>
</td>
</tr><tr id="section-101">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-101">&#182;</a>
  </div>
  
<p>.org directives in the middle</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
.org 0
add
.org 5
add ]]</span>, {0x04, 0, 0, 0, 0, 0x04})
</pre></div>
</td>
</tr><tr id="section-102">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-102">&#182;</a>
  </div>
  
<p>.equ directives</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
foo: .equ 5
add foo ]]</span>, {0x05, 5})
</pre></div>
</td>
</tr><tr id="section-103">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-103">&#182;</a>
  </div>
  
<p>Jumping to labels</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
.org 0x0100
       push 10
start: dup
       add 0x1000
       store 0
       sub 1
       brz start]]</span>,
    {0x01, 0x0a, 0x3c, 0x06, 0x00, 0x10, 0x81, 0x00, 0x09, 0x01, 0x63, 0x02, 0x01, 0x00})
</pre></div>
</td>
</tr><tr id="section-104">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-104">&#182;</a>
  </div>
  
<p>.db directives</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
add 10
.db 0x1234]]</span>, {0x05, 10, 0x34, 0x12, 0x00})
</pre></div>
</td>
</tr><tr id="section-105">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-105">&#182;</a>
  </div>
  
<p>.db directives with .orgs</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
.org 0x100
add 10
.db 0x1234]]</span>, {0x05, 10, 0x34, 0x12, 0x00})
</pre></div>
</td>
</tr><tr id="section-106">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-106">&#182;</a>
  </div>
  
<p>.db directives with strings</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
.org 0x100
add 10
.db "Hello"]]</span>, {0x05, 10, 0x48, 0x65, 0x6c, 0x6c, 0x6f})
</pre></div>
</td>
</tr><tr id="section-107">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-107">&#182;</a>
  </div>
  
<p>.db directives with strings and escapes</p>


</td>
<td class="code">
  <div class="highlight"><pre>test_assemble(<span class="s">[[
.org 0x100
add 10
.db "Hello\0"]]</span>, {0x05, 10, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x00})
</pre></div>
</td>
</tr></tbody>
    </table>
  </div>
</body>
</html>