<!DOCTYPE html>

<html>
<head>
  <title>vulcan.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="locco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
              vulcan.lua
            </h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
<tr id="section-1">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-1">&#182;</a>
  </div>
  
<h3>Purpose</h3>
<p>This is going to be an emulator / development tool for the Vulcan microcomputer.
It will be able to parse assembly files and run them, including an emulation of the
video display and keyboard in a window.</p>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-2">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-2">&#182;</a>
  </div>
  
<h3>Dependencies</h3>
<p>To parse Vulcan assembly, we'll need a parser library, so, LPeg:</p>


</td>
<td class="code">
  <div class="highlight"><pre>lpeg = <span class="nt">require</span>(<span class="s">'lpeg'</span>)
</pre></div>
</td>
</tr><tr id="section-3">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-3">&#182;</a>
  </div>
  
<h1>Utility functions</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-4">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-4">&#182;</a>
  </div>
  
<p>Map a function across a table</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">table:map</span>(fn)
    <span class="k">local</span> t = {}
    <span class="k">for</span> _, v <span class="k">in</span> <span class="nt">ipairs</span>(self) <span class="k">do</span>
        table.insert(t, fn(v))
    <span class="k">end</span>
    <span class="k">return</span> t
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-5">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-5">&#182;</a>
  </div>
  
<p>Reduce a table with a function</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">table:reduce</span>(fn, sum)
    <span class="k">local</span> start_idx = 1
    <span class="k">if</span> <span class="o">not</span> sum <span class="k">then</span>
        start_idx = 2
        sum = self[1]
    <span class="k">end</span>

    <span class="k">for</span> i = start_idx, #self <span class="k">do</span>
        sum = fn(sum, self[i])
    <span class="k">end</span>

    <span class="k">return</span> sum
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-6">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-6">&#182;</a>
  </div>
  
<h1>Assembly parser</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-7">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-7">&#182;</a>
  </div>
  
<p>Put this all in a function so we don't have a bunch of
stuff in the namespace</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">statement_pattern</span>()
</pre></div>
</td>
</tr><tr id="section-8">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-8">&#182;</a>
  </div>
  
<p>First, we want to define some basic patterns. <code>space</code> will be any sequence of whitespace,
so we can ignore it easily:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> space = lpeg.S(<span class="s">" \t"</span>)^0
</pre></div>
</td>
</tr><tr id="section-9">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-9">&#182;</a>
  </div>
  
<p>A comment will start with a semicolon and go to the end of the line. Actually everything is parsed
line by line, so anything that starts with a semicolon is a comment:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> comment = lpeg.P(<span class="s">';'</span>) * lpeg.P(1)^0
</pre></div>
</td>
</tr><tr id="section-10">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-10">&#182;</a>
  </div>
  
<p>Numbers are more complicated. We'll support three formats:</p>

<ul>
    <li>Decimal numbers like 42</li>
    <li>Hexadecimal like 0x2a</li>
    <li>Binary like 0b00101010</li>
</ul>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> dec_number = (lpeg.R(<span class="s">'19'</span>) * lpeg.R(<span class="s">'09'</span>)^0) / <span class="nt">tonumber</span>
    <span class="k">local</span> hex_number = lpeg.P(<span class="s">'0x'</span>) * lpeg.C(lpeg.R(<span class="s">'09'</span>,<span class="s">'af'</span>,<span class="s">'AF'</span>)^1) / <span class="k">function</span>(s) <span class="k">return</span> <span class="nt">tonumber</span>(s, 16) <span class="k">end</span>
    <span class="k">local</span> bin_number = lpeg.P(<span class="s">'0b'</span>) * lpeg.C(lpeg.S(<span class="s">'01'</span>)^1) / <span class="k">function</span>(s) <span class="k">return</span> <span class="nt">tonumber</span>(s, 2) <span class="k">end</span>
    <span class="k">local</span> number = dec_number + hex_number + bin_number
</pre></div>
</td>
</tr><tr id="section-11">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-11">&#182;</a>
  </div>
  
<p>A label can be any sequence of C-identifier-y characters, as long as it doesn't start with
a digit:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> label_char = (lpeg.R(<span class="s">'az'</span>, <span class="s">'AZ'</span>) + lpeg.S(<span class="s">'_$'</span>))
    <span class="k">local</span> label = lpeg.C(label_char * (label_char + lpeg.R(<span class="s">'09'</span>))^0)
</pre></div>
</td>
</tr><tr id="section-12">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-12">&#182;</a>
  </div>
  
<h2>Opcodes</h2>
<p>An opcode is any one of several possible strings:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> opcodes = {
        <span class="s">'push'</span>, <span class="s">'nop'</span>, <span class="s">'hlt'</span>, <span class="s">'pop'</span>, <span class="c">-- Basic instructions
</span>        <span class="s">'dup'</span>, <span class="s">'2dup'</span>, <span class="s">'swap'</span>, <span class="s">'pick'</span>, <span class="s">'height'</span>, <span class="c">-- Stack instructions
</span>        <span class="s">'add'</span>, <span class="s">'sub'</span>, <span class="s">'mul'</span>, <span class="s">'div'</span>, <span class="s">'mod'</span>, <span class="c">-- Arithmetic instructions
</span>        <span class="s">'and'</span>, <span class="s">'or'</span>, <span class="s">'xor'</span>, <span class="s">'not'</span>, <span class="s">'lshift'</span>, <span class="s">'rshift'</span>, <span class="s">'arshift'</span>, <span class="c">-- Logic instructions
</span>        <span class="s">'jmp'</span>, <span class="s">'jmpr'</span>, <span class="s">'call'</span>, <span class="s">'ret'</span>, <span class="s">'brz'</span>, <span class="s">'brnz'</span>, <span class="s">'brgt'</span>, <span class="s">'brlt'</span>, <span class="c">-- Branching and jumping
</span>        <span class="s">'load24'</span>, <span class="s">'load16'</span>, <span class="s">'load'</span>, <span class="s">'vload24'</span>, <span class="s">'vload16'</span>, <span class="s">'vload'</span>, <span class="c">-- Loading from memory
</span>        <span class="s">'store24'</span>, <span class="s">'store16'</span>, <span class="s">'store'</span>, <span class="s">'vstore24'</span>, <span class="s">'vstore16'</span>, <span class="s">'vstore'</span> <span class="c">-- Storing to memory
</span>    }
</pre></div>
</td>
</tr><tr id="section-13">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-13">&#182;</a>
  </div>
  
<p>Combine the opcodes into one pattern:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> opcode = lpeg.C(
        table.reduce(
            table.map(opcodes, lpeg.P),
            <span class="k">function</span>(a, b)
                <span class="k">return</span> a+b
            <span class="k">end</span>
    ))
</pre></div>
</td>
</tr><tr id="section-14">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-14">&#182;</a>
  </div>
  
<h2>Directives</h2>
<p>The assembler will support some directives:</p>

<ul>
    <li>.org to set the current address</li>
    <li>.db to embed some data</li>
    <li>.equ to define some constants</li>
</ul>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> directive = lpeg.C(lpeg.P(<span class="s">'.org'</span>) + lpeg.P(<span class="s">'.db'</span>) + lpeg.P(<span class="s">'.equ'</span>))
</pre></div>
</td>
</tr><tr id="section-15">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-15">&#182;</a>
  </div>
  
<p>The .equ directive isn't much use without the ability to have expressions based on
symbols, so, a quick arithmetic expression parser:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> expr = lpeg.P{
        <span class="s">'EXPR'</span>;
        EXPR = lpeg.Ct( lpeg.Cc(<span class="s">'expr'</span>) * lpeg.V(<span class="s">'TERM'</span>) * (lpeg.C( lpeg.S(<span class="s">'+-'</span>) ) * lpeg.V(<span class="s">'TERM'</span>))^0 ),
        TERM = lpeg.Ct( lpeg.Cc(<span class="s">'term'</span>) * lpeg.V(<span class="s">'FACT'</span>) * (lpeg.C( lpeg.S(<span class="s">'/*'</span>) ) * lpeg.V(<span class="s">'FACT'</span>))^0 ),
        FACT = (space * <span class="s">'('</span> * lpeg.V(<span class="s">'EXPR'</span>) * <span class="s">')'</span>) + (space * (number + label) * space)
    }
</pre></div>
</td>
</tr><tr id="section-16">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-16">&#182;</a>
  </div>
  
<p>Likewise, .db would get tedious quick without a string syntax, so, let's define one of those. An escape
sequence is a backslash followed by certain other characters:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> escape = lpeg.C(lpeg.P(<span class="s">'\\'</span>) * lpeg.S(<span class="s">'trns0"\\'</span>))
</pre></div>
</td>
</tr><tr id="section-17">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-17">&#182;</a>
  </div>
  
<p>And a string is a quoted sequence of escapes or other characters:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> string_pattern = lpeg.Ct(lpeg.Cc(<span class="s">'string'</span>) * lpeg.P(<span class="s">'"'</span>) * lpeg.Ct((lpeg.C(lpeg.P(1)-lpeg.S(<span class="s">'"\\'</span>)) + escape)^1) * <span class="s">'"'</span>)
</pre></div>
</td>
</tr><tr id="section-18">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-18">&#182;</a>
  </div>
  
<h2>Parsing a line</h2>
<p>Normally an assembly line will be a sequence of "label, opcode, argument, comment."
However, most of these elements are optional. An opcode is only required if an
argument exists. Comments are parsed but don't capture anything.</p>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-19">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-19">&#182;</a>
  </div>
  
<p>Some sub-patterns for the portions of a line:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> label_group = lpeg.Cc(<span class="s">'label'</span>) * label * <span class="s">':'</span>
    <span class="k">local</span> argument_group = lpeg.Cc(<span class="s">'argument'</span>) * (expr + string_pattern)
    <span class="k">local</span> comment_group = comment
</pre></div>
</td>
</tr><tr id="section-20">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-20">&#182;</a>
  </div>
  
<p>An opcode might be an actual opcode, or a directive</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> opcode_group = lpeg.Cc(<span class="s">'opcode'</span>) * opcode + lpeg.Cc(<span class="s">'directive'</span>) * directive
    <span class="k">local</span> instruction_group = opcode_group * space * argument_group^-1
</pre></div>
</td>
</tr><tr id="section-21">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-21">&#182;</a>
  </div>
  
<p>Finally the entire pattern for an assembly line:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">return</span> lpeg.Ct(label_group^-1 * space * instruction_group^-1 * space * comment_group^-1 * lpeg.P(-1))
<span class="k">end</span>

statement = statement_pattern()

<span class="k">return</span> statement
</pre></div>
</td>
</tr></tbody>
    </table>
  </div>
</body>
</html>