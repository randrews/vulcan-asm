<!DOCTYPE html>

<html>
<head>
  <title>vulcan.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="locco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
              vulcan.lua
            </h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
<tr id="section-1">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-1">&#182;</a>
  </div>
  
<h3>Purpose</h3>
<p>This is going to be an emulator / development tool for the Vulcan microcomputer.
It will be able to parse assembly files and run them, including an emulation of the
video display and keyboard in a window.</p>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-2">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-2">&#182;</a>
  </div>
  
<h3>Dependencies</h3>
<p>To parse Vulcan assembly, we'll need a parser library, so, LPeg:</p>


</td>
<td class="code">
  <div class="highlight"><pre>lpeg = <span class="nt">require</span>(<span class="s">'lpeg'</span>)
</pre></div>
</td>
</tr><tr id="section-3">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-3">&#182;</a>
  </div>
  
<h1>Utility functions</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-4">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-4">&#182;</a>
  </div>
  
<p>Map a function across a table</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">table:map</span>(fn)
    <span class="k">local</span> t = {}
    <span class="k">for</span> _, v <span class="k">in</span> <span class="nt">ipairs</span>(self) <span class="k">do</span>
        table.insert(t, fn(v))
    <span class="k">end</span>
    <span class="k">return</span> t
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-5">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-5">&#182;</a>
  </div>
  
<p>Reduce a table with a function</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">table:reduce</span>(fn, sum)
    <span class="k">local</span> start_idx = 1
    <span class="k">if</span> <span class="o">not</span> sum <span class="k">then</span>
        start_idx = 2
        sum = self[1]
    <span class="k">end</span>

    <span class="k">for</span> i = start_idx, #self <span class="k">do</span>
        sum = fn(sum, self[i])
    <span class="k">end</span>

    <span class="k">return</span> sum
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-6">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-6">&#182;</a>
  </div>
  
<h1>Assembly parser</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-7">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-7">&#182;</a>
  </div>
  
<p>Put this all in a function so we don't have a bunch of
stuff in the namespace</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">statement_pattern</span>()
</pre></div>
</td>
</tr><tr id="section-8">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-8">&#182;</a>
  </div>
  
<p>First, we want to define some basic patterns. <code>space</code> will be any sequence of whitespace,
so we can ignore it easily:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> space = lpeg.S(<span class="s">" \t"</span>)^0
</pre></div>
</td>
</tr><tr id="section-9">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-9">&#182;</a>
  </div>
  
<p>A comment will start with a semicolon and go to the end of the line. Actually everything is parsed
line by line, so anything that starts with a semicolon is a comment:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> comment = lpeg.P(<span class="s">';'</span>) * lpeg.P(1)^0
</pre></div>
</td>
</tr><tr id="section-10">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-10">&#182;</a>
  </div>
  
<p>Numbers are more complicated. We'll support three formats:</p>

<ul>
    <li>Decimal numbers like 42</li>
    <li>Hexadecimal like 0x2a</li>
    <li>Binary like 0b00101010</li>
</ul>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> dec_number = (lpeg.R(<span class="s">'19'</span>) * lpeg.R(<span class="s">'09'</span>)^0) / <span class="nt">tonumber</span>
    <span class="k">local</span> hex_number = lpeg.P(<span class="s">'0x'</span>) * lpeg.C(lpeg.R(<span class="s">'09'</span>,<span class="s">'af'</span>,<span class="s">'AF'</span>)^1) / <span class="k">function</span>(s) <span class="k">return</span> <span class="nt">tonumber</span>(s, 16) <span class="k">end</span>
    <span class="k">local</span> bin_number = lpeg.P(<span class="s">'0b'</span>) * lpeg.C(lpeg.S(<span class="s">'01'</span>)^1) / <span class="k">function</span>(s) <span class="k">return</span> <span class="nt">tonumber</span>(s, 2) <span class="k">end</span>
    <span class="k">local</span> number = dec_number + hex_number + bin_number
</pre></div>
</td>
</tr><tr id="section-11">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-11">&#182;</a>
  </div>
  
<p>A label can be any sequence of C-identifier-y characters, as long as it doesn't start with
a digit:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> label_char = (lpeg.R(<span class="s">'az'</span>, <span class="s">'AZ'</span>) + lpeg.S(<span class="s">'_$'</span>))
    <span class="k">local</span> label = lpeg.C(label_char * (label_char + lpeg.R(<span class="s">'09'</span>))^0)
</pre></div>
</td>
</tr><tr id="section-12">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-12">&#182;</a>
  </div>
  
<h2>Opcodes</h2>
<p>An opcode is any one of several possible strings:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> opcodes = {
        <span class="s">'push'</span>, <span class="s">'nop'</span>, <span class="s">'hlt'</span>, <span class="s">'pop'</span>, <span class="c">-- Basic instructions
</span>        <span class="s">'dup'</span>, <span class="s">'2dup'</span>, <span class="s">'swap'</span>, <span class="s">'pick'</span>, <span class="s">'height'</span>, <span class="c">-- Stack instructions
</span>        <span class="s">'add'</span>, <span class="s">'sub'</span>, <span class="s">'mul'</span>, <span class="s">'div'</span>, <span class="s">'mod'</span>, <span class="c">-- Arithmetic instructions
</span>        <span class="s">'and'</span>, <span class="s">'or'</span>, <span class="s">'xor'</span>, <span class="s">'not'</span>, <span class="s">'lshift'</span>, <span class="s">'rshift'</span>, <span class="s">'arshift'</span>, <span class="c">-- Logic instructions
</span>        <span class="s">'jmp'</span>, <span class="s">'jmpr'</span>, <span class="s">'call'</span>, <span class="s">'ret'</span>, <span class="s">'brz'</span>, <span class="s">'brnz'</span>, <span class="s">'brgt'</span>, <span class="s">'brlt'</span>, <span class="c">-- Branching and jumping
</span>        <span class="s">'load24'</span>, <span class="s">'load16'</span>, <span class="s">'load'</span>, <span class="s">'vload24'</span>, <span class="s">'vload16'</span>, <span class="s">'vload'</span>, <span class="c">-- Loading from memory
</span>        <span class="s">'store24'</span>, <span class="s">'store16'</span>, <span class="s">'store'</span>, <span class="s">'vstore24'</span>, <span class="s">'vstore16'</span>, <span class="s">'vstore'</span> <span class="c">-- Storing to memory
</span>    }
</pre></div>
</td>
</tr><tr id="section-13">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-13">&#182;</a>
  </div>
  
<p>Combine the opcodes into one pattern:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> opcode = lpeg.C(
        table.reduce(
            table.map(opcodes, lpeg.P),
            <span class="k">function</span>(a, b)
                <span class="k">return</span> a+b
            <span class="k">end</span>
    ))
</pre></div>
</td>
</tr><tr id="section-14">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-14">&#182;</a>
  </div>
  
<h2>Directives</h2>
<p>The assembler will support some directives:</p>

<ul>
    <li>.org to set the current address</li>
    <li>.db to embed some data</li>
    <li>.equ to define some constants</li>
</ul>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> directive = lpeg.C(lpeg.P(<span class="s">'.org'</span>) + lpeg.P(<span class="s">'.db'</span>) + lpeg.P(<span class="s">'.equ'</span>))
</pre></div>
</td>
</tr><tr id="section-15">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-15">&#182;</a>
  </div>
  
<p>The .equ directive isn't much use without the ability to have expressions based on
symbols, so, a quick arithmetic expression parser:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> expr = lpeg.P{
        <span class="s">'EXPR'</span>;
        EXPR = lpeg.Ct( lpeg.Cc(<span class="s">'expr'</span>) * lpeg.V(<span class="s">'TERM'</span>) * (lpeg.C( lpeg.S(<span class="s">'+-'</span>) ) * lpeg.V(<span class="s">'TERM'</span>))^0 ),
        TERM = lpeg.Ct( lpeg.Cc(<span class="s">'term'</span>) * lpeg.V(<span class="s">'FACT'</span>) * (lpeg.C( lpeg.S(<span class="s">'/*&#37;'</span>) ) * lpeg.V(<span class="s">'FACT'</span>))^0 ),
        FACT = (space * <span class="s">'('</span> * lpeg.V(<span class="s">'EXPR'</span>) * <span class="s">')'</span>) + (space * (number + label) * space)
    }
</pre></div>
</td>
</tr><tr id="section-16">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-16">&#182;</a>
  </div>
  
<p>Likewise, .db would get tedious quick without a string syntax, so, let's define one of those. An escape
sequence is a backslash followed by certain other characters:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> escape = lpeg.C(lpeg.P(<span class="s">'\\'</span>) * lpeg.S(<span class="s">'trns0"\\'</span>))
</pre></div>
</td>
</tr><tr id="section-17">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-17">&#182;</a>
  </div>
  
<p>And a string is a quoted sequence of escapes or other characters:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> string_pattern = lpeg.Ct(lpeg.Cc(<span class="s">'string'</span>) * lpeg.P(<span class="s">'"'</span>) * lpeg.Ct((lpeg.C(lpeg.P(1)-lpeg.S(<span class="s">'"\\'</span>)) + escape)^1) * <span class="s">'"'</span>)
</pre></div>
</td>
</tr><tr id="section-18">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-18">&#182;</a>
  </div>
  
<h2>Parsing a line</h2>
<p>Normally an assembly line will be a sequence of "label, opcode, argument, comment."
However, most of these elements are optional. An opcode is only required if an
argument exists. Comments are parsed but don't capture anything.</p>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-19">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-19">&#182;</a>
  </div>
  
<p>Some sub-patterns for the portions of a line:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> label_group = lpeg.Cc(<span class="s">'label'</span>) * label * <span class="s">':'</span>
    <span class="k">local</span> argument_group = lpeg.Cc(<span class="s">'argument'</span>) * (expr + string_pattern)
    <span class="k">local</span> comment_group = comment
</pre></div>
</td>
</tr><tr id="section-20">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-20">&#182;</a>
  </div>
  
<p>An opcode might be an actual opcode, or a directive</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> opcode_group = lpeg.Cc(<span class="s">'opcode'</span>) * opcode + lpeg.Cc(<span class="s">'directive'</span>) * directive
    <span class="k">local</span> instruction_group = opcode_group * space * argument_group^-1
</pre></div>
</td>
</tr><tr id="section-21">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-21">&#182;</a>
  </div>
  
<p>Finally the entire pattern for an assembly line:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">return</span> lpeg.Ct(label_group^-1 * space * instruction_group^-1 * space * comment_group^-1 * lpeg.P(-1))
<span class="k">end</span>

statement = statement_pattern()
</pre></div>
</td>
</tr><tr id="section-22">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-22">&#182;</a>
  </div>
  
<h1>Assembler</h1>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-23">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-23">&#182;</a>
  </div>
  
<h2>First pass</h2>
<p>Assembly parser. This will take in an iterator from which we can load lines of assembly, and return a
list of parsed lines, but with expressions un-evaluated:</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">parse_assembly</span>(iterator)
</pre></div>
</td>
</tr><tr id="section-24">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-24">&#182;</a>
  </div>
  
<p>This will store the eventual output</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> lines = {}
</pre></div>
</td>
</tr><tr id="section-25">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-25">&#182;</a>
  </div>
  
<p>A count of the line number</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> line_num = 1
</pre></div>
</td>
</tr><tr id="section-26">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-26">&#182;</a>
  </div>
  
<p>Parse each line, throw out all the semantically blank ones:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">for</span> line <span class="k">in</span> iterator <span class="k">do</span>
        <span class="k">local</span> ast = statement:match(line)
</pre></div>
</td>
</tr><tr id="section-27">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-27">&#182;</a>
  </div>
  
<p>If we weren't able to parse it, blow up:</p>


</td>
<td class="code">
  <div class="highlight"><pre>        <span class="k">if</span> ast == <span class="k">nil</span> <span class="k">then</span>
            <span class="nt">error</span>(<span class="s">'Parse error on line '</span> .. line_num .. <span class="s">': '</span> .. string.format(<span class="s">'&#37;q'</span>, line))
        <span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-28">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-28">&#182;</a>
  </div>
  
<p>If it parsed to a null statement (nothing but a comment / whitespace)
then just skip it:</p>


</td>
<td class="code">
  <div class="highlight"><pre>        <span class="k">if</span> #ast &gt; 0 <span class="k">then</span>
</pre></div>
</td>
</tr><tr id="section-29">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-29">&#182;</a>
  </div>
  
<p>Otherwise, start by converting it to a more useful key/value format,
and embed the line number in it while we're at it:</p>


</td>
<td class="code">
  <div class="highlight"><pre>            <span class="k">local</span> obj = { line=line_num }
            <span class="k">for</span> n = 1, #ast, 2 <span class="k">do</span>
                obj[ast[n]] = ast[n+1]
            <span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-30">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-30">&#182;</a>
  </div>
  
<p>We'll identify two possible errors here, just because we can: if a line
has a string argument and it <em>isn't</em> a <code>.db</code> directive, then that's a
syntax error and we'll say so:</p>


</td>
<td class="code">
  <div class="highlight"><pre>            <span class="k">if</span> obj.argument <span class="o">and</span> obj.argument[1] == <span class="s">'string'</span> <span class="o">and</span> obj.directive ~= <span class="s">'.db'</span> <span class="k">then</span>
                <span class="nt">error</span>(<span class="s">'String argument outside .db directive on line '</span> .. line_num)
            <span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-31">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-31">&#182;</a>
  </div>
  
<p>Also, a .equ without a label or argument makes no sense, so we'll error
on that as well:</p>


</td>
<td class="code">
  <div class="highlight"><pre>            <span class="k">if</span> obj.directive == <span class="s">'.equ'</span> <span class="o">and</span> (obj.argument == <span class="k">nil</span> <span class="o">or</span> obj.label == <span class="k">nil</span>) <span class="k">then</span>
                <span class="nt">error</span>(<span class="s">'.equ directive missing label or argument on line'</span> .. line_num)
            <span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-32">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-32">&#182;</a>
  </div>
  
<p>Tack it on to the list of actual lines:</p>


</td>
<td class="code">
  <div class="highlight"><pre>            table.insert(lines, obj)
        <span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-33">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-33">&#182;</a>
  </div>
  
<p>Next line number:</p>


</td>
<td class="code">
  <div class="highlight"><pre>        line_num = line_num + 1
    <span class="k">end</span>

    <span class="k">return</span> lines
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-34">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-34">&#182;</a>
  </div>
  
<h2>Evaluating expressions</h2>
<p>Now that we have a parsed file, that file has a bunch of numeric symbols in it: labels,
.equ directives, that sort of thing. We need to resolve all of those to constant values
before we can generate code. So, first part of that is being able to evaluate expressions.</p>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-35">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-35">&#182;</a>
  </div>
  
<p>Evaluate an expression in the context of a symbol table:</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">evaluate</span>(expr, symbols)
</pre></div>
</td>
</tr><tr id="section-36">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-36">&#182;</a>
  </div>
  
<p>The bottom of a parse tree, just return a number</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">if</span> <span class="nt">type</span>(expr) == <span class="s">'number'</span> <span class="k">then</span>
        <span class="k">return</span> expr
</pre></div>
</td>
</tr><tr id="section-37">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-37">&#182;</a>
  </div>
  
<p>A symbol that had better be defined</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">elseif</span> <span class="nt">type</span>(expr) == <span class="s">'string'</span> <span class="k">then</span>
        <span class="k">if</span> symbols[expr] <span class="k">then</span> <span class="k">return</span> symbols[expr]
        <span class="k">else</span> <span class="nt">error</span>(<span class="s">'Symbol not defined: '</span> .. expr) <span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-38">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-38">&#182;</a>
  </div>
  
<p>This is a list of terms separated by arithmetic operators. So,
evaluate the first one...</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">elseif</span> expr[1] == <span class="s">'expr'</span> <span class="o">or</span> expr[1] == <span class="s">'term'</span> <span class="k">then</span>
        <span class="k">local</span> val = evaluate(expr[2], symbols)
</pre></div>
</td>
</tr><tr id="section-39">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-39">&#182;</a>
  </div>
  
<p>Then go through the list two at a time...</p>


</td>
<td class="code">
  <div class="highlight"><pre>        <span class="k">for</span> i = 3, #expr, 2 <span class="k">do</span>
            <span class="k">local</span> operator = expr[i]
</pre></div>
</td>
</tr><tr id="section-40">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-40">&#182;</a>
  </div>
  
<p>Evaluating the rest...</p>


</td>
<td class="code">
  <div class="highlight"><pre>            <span class="k">local</span> rhs = evaluate(expr[i+1], symbols)
</pre></div>
</td>
</tr><tr id="section-41">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-41">&#182;</a>
  </div>
  
<p>And adding or subtracting them or whatever</p>


</td>
<td class="code">
  <div class="highlight"><pre>            <span class="k">if</span> operator == <span class="s">'+'</span> <span class="k">then</span>
                val = val + rhs
            <span class="k">elseif</span> operator == <span class="s">'-'</span> <span class="k">then</span>
                val = val - rhs
            <span class="k">elseif</span> operator == <span class="s">'*'</span> <span class="k">then</span>
                val = val * rhs
            <span class="k">elseif</span> operator == <span class="s">'/'</span> <span class="k">then</span>
</pre></div>
</td>
</tr><tr id="section-42">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-42">&#182;</a>
  </div>
  
<p>Lua has floating point division, but Vulcan will only support integer
truncating division</p>


</td>
<td class="code">
  <div class="highlight"><pre>                val = math.floor(val / rhs)
            <span class="k">elseif</span> operator == <span class="s">'&#37;'</span> <span class="k">then</span>
                val = val &#37; rhs
            <span class="k">end</span>
        <span class="k">end</span>
        <span class="k">return</span> val
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-43">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-43">&#182;</a>
  </div>
  
<p>Return a list of all symbols referenced by this expression:</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">references</span>(expr)
</pre></div>
</td>
</tr><tr id="section-44">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-44">&#182;</a>
  </div>
  
<p>A set (map from name to 'true') of all references</p>


</td>
<td class="code">
  <div class="highlight"><pre>    refs = {}
</pre></div>
</td>
</tr><tr id="section-45">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-45">&#182;</a>
  </div>
  
<p>A helper function to do the recursion</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> <span class="k">function</span> <span class="nf">search</span>(e)
</pre></div>
</td>
</tr><tr id="section-46">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-46">&#182;</a>
  </div>
  
<p>If it's a reference, then add it to the </p>


</td>
<td class="code">
  <div class="highlight"><pre>        <span class="k">if</span> <span class="nt">type</span>(e) == <span class="s">'string'</span> <span class="k">then</span> refs[e] = <span class="k">true</span>
</pre></div>
</td>
</tr><tr id="section-47">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-47">&#182;</a>
  </div>
  
<p>Otherwise we need to recurse on a sub-tree:</p>


</td>
<td class="code">
  <div class="highlight"><pre>        <span class="k">elseif</span> <span class="nt">type</span>(e) == <span class="s">'table'</span> <span class="k">then</span>
            search(e[2])
            <span class="k">for</span> i = 4, #e, 2 <span class="k">do</span> search(e[i]) <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-48">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-48">&#182;</a>
  </div>
  
<p>Convert refs to a list:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> ref_list = {}
    <span class="k">for</span> k, _ <span class="k">in</span> <span class="nt">pairs</span>(refs) <span class="k">do</span> table.insert(ref_list, k) <span class="k">end</span>
    <span class="k">return</span> ref_list
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-49">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-49">&#182;</a>
  </div>
  
<h2>Second pass</h2>
<p>This will solve all the .equ directives and return a symbol table of them.
.equ directives must be able to be solved in order, that is, in terms of
only preceding .equ directives. Anything else is an error.</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">solve_equs</span>(lines)
    <span class="k">local</span> symbols = {}

    <span class="k">for</span> _, line <span class="k">in</span> <span class="nt">ipairs</span>(lines) <span class="k">do</span>
</pre></div>
</td>
</tr><tr id="section-50">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-50">&#182;</a>
  </div>
  
<p>Is this a .equ?</p>


</td>
<td class="code">
  <div class="highlight"><pre>        <span class="k">if</span> line.directive == <span class="s">'.equ'</span> <span class="k">then</span>
</pre></div>
</td>
</tr><tr id="section-51">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-51">&#182;</a>
  </div>
  
<p>Try to solve it with what we know so far:</p>


</td>
<td class="code">
  <div class="highlight"><pre>            <span class="k">local</span> success, ret = <span class="nt">pcall</span>(evaluate, line.argument, symbols)
</pre></div>
</td>
</tr><tr id="section-52">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-52">&#182;</a>
  </div>
  
<p>Put it in the symbols, or blow up:</p>


</td>
<td class="code">
  <div class="highlight"><pre>            <span class="k">if</span> success <span class="k">then</span>
                symbols[line.label] = ret
            <span class="k">else</span>
                <span class="nt">error</span>(<span class="s">'Cannot resolve .equ on line '</span> .. line.line .. <span class="s">': '</span> .. ret)
            <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">return</span> symbols
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-53">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-53">&#182;</a>
  </div>
  
<h2>Third pass</h2>
<p>We need to figure out the instruction lengths. We'll do this naively; if we can't
immediately tell that an instruction needs only a 0/1/2 byte argument (because it's
a constant, or a .equ that we've solved, or something) then we'll assume it's a
full 24-bit argument.</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">measure_instructions</span>(lines, symbols)
    <span class="k">for</span> _, line <span class="k">in</span> <span class="nt">ipairs</span>(lines) <span class="k">do</span>
</pre></div>
</td>
</tr><tr id="section-54">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-54">&#182;</a>
  </div>
  
<p>Does this even represent any real output bytes?</p>


</td>
<td class="code">
  <div class="highlight"><pre>        <span class="k">if</span> <span class="o">not</span>(line.opcode <span class="o">or</span> line.directive == <span class="s">'.db'</span>) <span class="k">then</span>
            line.length = 0
        <span class="k">elseif</span> line.directive == <span class="s">'.db'</span> <span class="k">then</span>
</pre></div>
</td>
</tr><tr id="section-55">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-55">&#182;</a>
  </div>
  
<p>.dbs with string arguments, we know the length.
Else, set aside 3 bytes for a number. (Even if it fits in fewer,
it may be a variable that we're setting aside space for)</p>


</td>
<td class="code">
  <div class="highlight"><pre>            <span class="k">if</span> line.argument[1] == <span class="s">'string'</span> <span class="k">then</span>
                line.length = #(line.argument[2])
            <span class="k">else</span>
                line.length = 3
            <span class="k">end</span>
        <span class="k">elseif</span> line.opcode <span class="k">then</span>
</pre></div>
</td>
</tr><tr id="section-56">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-56">&#182;</a>
  </div>
  
<p>If it has no argument, then it's only one byte obviously</p>


</td>
<td class="code">
  <div class="highlight"><pre>            <span class="k">if</span> <span class="o">not</span> line.argument <span class="k">then</span>
                line.length = 1
            <span class="k">else</span>
</pre></div>
</td>
</tr><tr id="section-57">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-57">&#182;</a>
  </div>
  
<p>Evaluate the argument, if we can with just .equs:</p>


</td>
<td class="code">
  <div class="highlight"><pre>                <span class="k">local</span> success, val = <span class="nt">pcall</span>(evaluate, line.argument, symbols)
</pre></div>
</td>
</tr><tr id="section-58">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-58">&#182;</a>
  </div>
  
<p>If we failed to do that, then let's just set aside the
full 24 bits:</p>


</td>
<td class="code">
  <div class="highlight"><pre>                <span class="k">if</span> <span class="o">not</span> success <span class="k">then</span> line.length = 4
                <span class="k">else</span>
</pre></div>
</td>
</tr><tr id="section-59">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-59">&#182;</a>
  </div>
  
<p>Otherwise let's see what we got. If it's less than 256,
it fits in a byte, and so on:</p>


</td>
<td class="code">
  <div class="highlight"><pre>                    <span class="k">if</span> val &lt; 256 <span class="k">then</span> line.length = 2
                    <span class="k">elseif</span> val &lt; 65536 <span class="k">then</span> line.length = 3
                    <span class="k">else</span> line.length = 4 <span class="k">end</span>
                <span class="k">end</span>
            <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-60">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-60">&#182;</a>
  </div>
  
<p>-- We want to calculate where the labels are, as the first step in calculating the values of
-- all the symbols. 
-- is less than four bytes, then we'll assume it's four bytes.
function calculate_labels(lines)</p>
<pre><code>local address = 0
-- Go through each line...
for _, line in ipairs(lines) do
    -- If the line is a .org directive, then we evaluate the argument as a constant,
    -- 
end
</code></pre>


</td>
<td class="code">
  <div class="highlight"><pre>
</pre></div>
</td>
</tr><tr id="section-61">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-61">&#182;</a>
  </div>
  
<pre><code>return dependencies
</code></pre>
<p>end</p>


</td>
<td class="code">
  <div class="highlight"><pre>
<span class="k">return</span> {
    statement=statement,
    parse_assembly=parse_assembly,
    evaluate=evaluate,
    solve_equs=solve_equs,
    measure_instructions=measure_instructions
}
</pre></div>
</td>
</tr></tbody>
    </table>
  </div>
</body>
</html>