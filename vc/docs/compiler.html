<!DOCTYPE html>

<html>
<head>
  <title>compiler.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="locco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    <div id="jump_to">
  Jump To &hellip;
  <div id="jump_wrapper">
  <div id="jump_page">
  <a class="source" href="compiler.html">compiler.lua</a>
  <a class="source" href="compiler_test.html">compiler_test.lua</a>
  <a class="source" href="parser.html">parser.lua</a>
  <a class="source" href="parser_test.html">parser_test.lua</a>
    </div>
  </div>
</div>

    <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
              compiler.lua
            </h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
<tr id="section-1">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-1">&#182;</a>
  </div>
  


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">local</span> parser = <span class="nt">require</span>(<span class="s">'parser'</span>)
</pre></div>
</td>
</tr><tr id="section-2">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-2">&#182;</a>
  </div>
  
<p>Compile a table containing a sequence of parsed statements
Env is a table with these members:</p>

<ul>
    <li>emit is a function that takes a string and emits that to the final asm</li>
    <li>gensym is a function that return unique, valid asm label names (optionally using an optional semantic name passed in)</li>
    <li>globals is a table mapping defined global names to symbols</li>
</ul>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">compile</span>(statements, env)
</pre></div>
</td>
</tr><tr id="section-3">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-3">&#182;</a>
  </div>
  
<p>This is given to us from outside, we have to call it in order for the final asm</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> final_emit = env.emit
</pre></div>
</td>
</tr><tr id="section-4">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-4">&#182;</a>
  </div>
  
<p>We have three segments in the program:
- Text, which gets emitted first and is all the expressions in the global context, followed by an implicit hlt
- Functions, emitted second and are all the functions
- Globals, emitted last and containing the labels and .db's for global variables (all initialized to 0, the initializers run where the declaration was, in text)</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> segments = {text = {}, functions = {}, globals = {}}
    env.emit_to_segment = <span class="k">function</span>(segment, line)
        <span class="nt">assert</span>(segments[segment], <span class="s">'Unknown segment '</span> .. segment)
        table.insert(segments[segment], line)
    <span class="k">end</span>
    env.emit = <span class="k">function</span>(line) env.emit_to_segment(<span class="s">'text'</span>, line) <span class="k">end</span>
    env.emit_global = <span class="k">function</span>(line) env.emit_to_segment(<span class="s">'globals'</span>, line) <span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-5">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-5">&#182;</a>
  </div>
  
<p>Try to compile each statement. There are a limited number of things it could be:</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">for</span> _, ast <span class="k">in</span> <span class="nt">ipairs</span>(statements) <span class="k">do</span>
        <span class="nt">assert</span>(ast[1] == <span class="s">'stmt'</span>, <span class="s">'Did not compile to a statement'</span>)

        <span class="k">if</span> ast[2][1] == <span class="s">'var'</span> <span class="k">then</span>
            compile_var(ast[2], env)
        <span class="k">elseif</span> ast[2][1] == <span class="s">'expr'</span> <span class="k">then</span>
            compile_expr(ast[2], env)
        <span class="k">end</span>
    <span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-6">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-6">&#182;</a>
  </div>
  
<p>Helper for emitting an entire segment to the final output at once</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> <span class="k">function</span> <span class="nf">emit_segment</span>(segment)
        <span class="k">for</span> _, line <span class="k">in</span> <span class="nt">ipairs</span>(segment) <span class="k">do</span> final_emit(line) <span class="k">end</span>
    <span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-7">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-7">&#182;</a>
  </div>
  
<p>Emit all of the text followed by a hlt</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">if</span> #segments.text &gt; 0 <span class="k">then</span>
        emit_segment(segments.text)
        final_emit(<span class="s">'hlt'</span>)
    <span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-8">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-8">&#182;</a>
  </div>
  
<p>If there are any functions or globals, emit those too.
They don't need hlts because functions will automatically return
and globals never get jumped to.</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">if</span> #segments.functions &gt; 0 <span class="k">then</span> emit_segment(segments.functions) <span class="k">end</span>
    <span class="k">if</span> #segments.globals &gt; 0 <span class="k">then</span> emit_segment(segments.globals) <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">compile_var</span>(var, env)
</pre></div>
</td>
</tr><tr id="section-9">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-9">&#182;</a>
  </div>
  
<p>Something for functions here</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">local</span> name = var[2]
    <span class="k">local</span> label = env.gensym(name)
    env.globals[name] = label
    env.emit_global(label .. <span class="s">': .db 0'</span>)

    <span class="k">local</span> typename = clause(var, <span class="s">'type'</span>)
    <span class="k">local</span> initial = clause(var, <span class="s">'init'</span>)

    <span class="k">if</span> initial <span class="k">then</span>
        compile_expr(initial[2], env)
        env.emit(<span class="s">'store24 '</span> .. label)
    <span class="k">end</span>

    <span class="k">if</span> typename <span class="k">then</span>
        <span class="nt">error</span>(<span class="s">'TODO'</span>)
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">compile_expr</span>(expr, env)
    <span class="k">for</span> index = 2, #expr, 2 <span class="k">do</span>
        <span class="k">local</span> term = expr[index]
        compile_term(term, env)
        <span class="k">if</span> index &gt; 2 <span class="k">then</span>
            <span class="k">local</span> op = expr[index-1]
            <span class="k">if</span> op == <span class="s">'+'</span> <span class="k">then</span> env.emit(<span class="s">'add'</span>)
            <span class="k">elseif</span> op == <span class="s">'-'</span> <span class="k">then</span> env.emit(<span class="s">'sub'</span>) <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">compile_term</span>(term, env)
    <span class="k">for</span> index = 2, #term, 2 <span class="k">do</span>
        <span class="k">local</span> fact = term[index]

        <span class="k">if</span> <span class="nt">type</span>(fact) == <span class="s">'number'</span> <span class="k">then</span> env.emit(<span class="s">'push '</span> .. fact)
        <span class="k">elseif</span> <span class="nt">type</span>(fact) == <span class="s">'table'</span> <span class="k">then</span>
            <span class="k">if</span> fact[1] == <span class="s">'expr'</span> <span class="k">then</span> compile_expr(fact, env)
            <span class="k">elseif</span> fact[1] == <span class="s">'new'</span> <span class="k">then</span> <span class="nt">error</span>(<span class="s">'TODO'</span>)
            <span class="k">elseif</span> fact[1] == <span class="s">'assign'</span> <span class="k">then</span> compile_assign(fact, env)
            <span class="k">elseif</span> fact[1] == <span class="s">'if'</span> <span class="k">then</span> <span class="nt">error</span>(<span class="s">'TODO'</span>)
            <span class="k">elseif</span> fact[1] == <span class="s">'id'</span> <span class="k">then</span> compile_id(fact, env)
            <span class="k">elseif</span> fact[1] == <span class="s">'string'</span> <span class="k">then</span> <span class="nt">error</span>(<span class="s">'TODO'</span>)
            <span class="k">elseif</span> fact[1] == <span class="s">'address'</span> <span class="k">then</span> compile_address(fact, env) <span class="k">end</span>
        <span class="k">end</span>

        <span class="k">if</span> index &gt; 2 <span class="k">then</span>
            <span class="k">local</span> op = term[index-1]
            <span class="k">if</span> op == <span class="s">'*'</span> <span class="k">then</span> env.emit(<span class="s">'mul'</span>)
            <span class="k">elseif</span> op == <span class="s">'/'</span> <span class="k">then</span> env.emit(<span class="s">'div'</span>)
            <span class="k">elseif</span> op == <span class="s">'&#37;'</span> <span class="k">then</span> env.emit(<span class="s">'mod'</span>) <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">compile_id</span>(id, env)
    <span class="k">local</span> name = id[2]
    <span class="k">if</span> env.globals[name] <span class="k">then</span>
        <span class="k">if</span> id[3] <span class="o">and</span> id[3][1] == <span class="s">'subscript'</span> <span class="k">then</span>
            compile_expr(id[3][2], env)
            env.emit(<span class="s">'mul 3'</span>)
            env.emit(<span class="s">'add '</span> .. env.globals[name])
            env.emit(<span class="s">'load24'</span>)
        <span class="k">elseif</span> id[3] <span class="o">and</span> id[3] == <span class="s">'params'</span> <span class="k">then</span> <span class="nt">error</span>(<span class="s">'TODO'</span>)
        <span class="k">elseif</span> id[3] <span class="o">and</span> id[3] == <span class="s">'member'</span> <span class="k">then</span> <span class="nt">error</span>(<span class="s">'TODO'</span>)
        <span class="k">elseif</span> <span class="o">not</span> id[3] <span class="k">then</span>
            env.emit(<span class="s">'load24 '</span> .. env.globals[name])
        <span class="k">end</span>
    <span class="k">else</span>
        <span class="nt">error</span>(<span class="s">'Unrecognized identifier: '</span> .. name)
    <span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-10">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-10">&#182;</a>
  </div>
  
<p>Something for function scopes later</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">end</span>
</pre></div>
</td>
</tr><tr id="section-11">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-11">&#182;</a>
  </div>
  
<p>An address reference (in an rvalue, not an lvalue)</p>


</td>
<td class="code">
  <div class="highlight"><pre><span class="k">function</span> <span class="nf">compile_address</span>(addr, env)
    compile_expr(addr[2], env)
    env.emit(<span class="s">'load24'</span>)
<span class="k">end</span>

<span class="k">function</span> <span class="nf">compile_assign</span>(assign, env)
    <span class="k">local</span> _, lvalue, rvalue = table.<span class="nt">unpack</span>(assign)
</pre></div>
</td>
</tr><tr id="section-12">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-12">&#182;</a>
  </div>
  
<p>Go ahead and emit the rvalue, it's now on top of the stack</p>


</td>
<td class="code">
  <div class="highlight"><pre>    compile_expr(rvalue, env)
</pre></div>
</td>
</tr><tr id="section-13">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-13">&#182;</a>
  </div>
  
<p>Deal with the lvalue</p>


</td>
<td class="code">
  <div class="highlight"><pre>    <span class="k">if</span> lvalue[1] == <span class="s">'address'</span> <span class="k">then</span>
    <span class="k">elseif</span> lvalue[1] == <span class="s">'id'</span> <span class="k">then</span>
        <span class="k">local</span> _, name, qualifier = table.<span class="nt">unpack</span>(lvalue)
</pre></div>
</td>
</tr><tr id="section-14">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-14">&#182;</a>
  </div>
  
<p>Something for function scopes</p>


</td>
<td class="code">
  <div class="highlight"><pre>        <span class="nt">assert</span>(env.globals[name], <span class="s">'Unrecognized name: '</span> .. name)
        <span class="k">if</span> qualifier <span class="k">then</span> <span class="c">-- It's either a subscript or a member
</span>            <span class="k">if</span> qualifier[1] == <span class="s">'subscript'</span> <span class="k">then</span>
                compile_expr(qualifier[2], env)
                env.emit(<span class="s">'mul 3'</span>)
                env.emit(<span class="s">'add '</span> .. env.globals[name])
                env.emit(<span class="s">'store24'</span>)
            <span class="k">else</span> <span class="nt">error</span>(<span class="s">'TODO'</span>) <span class="k">end</span>
        <span class="k">else</span>
            env.emit(<span class="s">'store24 '</span> .. env.globals[name])
        <span class="k">end</span>
    <span class="k">else</span> <span class="nt">error</span>(<span class="s">'Unrecognized lvalue: '</span> .. lvalue[1]) <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">clause</span>(node, name)
    <span class="k">for</span> _, child <span class="k">in</span> <span class="nt">ipairs</span>(node) <span class="k">do</span>
        <span class="k">if</span> <span class="nt">type</span>(child) == <span class="s">'table'</span> <span class="o">and</span> child[1] == name <span class="k">then</span>
            <span class="k">return</span> child
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">return</span> { compile = compile }
</pre></div>
</td>
</tr></tbody>
    </table>
  </div>
</body>
</html>